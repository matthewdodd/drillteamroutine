<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CAF Drill Simulator - Tempo Control</title>
    <style>
        :root {
            --air-color: #5d9cec; --army-color: #4a6741; --navy-color: #2c3e50;
            --cmd-color: #d9534f; --base-speed: 600ms;
        }
        body { font-family: 'Segoe UI', sans-serif; display: flex; background: #e9ecef; margin: 0; height: 100vh; overflow: hidden; }
        .is-marker .circle { border: 4px solid #ffdb58 !important; box-shadow: 0 0 15px #ffdb58 !important; }
        .is-pivot .circle { border: 4px solid #2ecc71 !important; box-shadow: 0 0 20px #2ecc71 !important; z-index: 50; }
        
        #sidebar { width: 380px; background: #fff; border-right: 2px solid #ccc; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; box-sizing: border-box; }
        .move-item { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; background: #f8f9fa; padding: 10px; border-radius: 6px; border: 1px solid #ddd; position: relative; }
        .move-item.active { border-left: 5px solid #2e7d32; background: #e8f5e9; }
        
        #main { flex-grow: 1; display: flex; flex-direction: column; align-items: center; padding: 20px; position: relative; overflow: auto; }
        .controls { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; gap: 15px; align-items: center; z-index: 100; }
        
        #grid-floor { 
            position: relative; background: #fff; border: 2px solid #333;
            background-image: linear-gradient(#ddd 1px, transparent 1px), linear-gradient(90deg, #ddd 1px, transparent 1px);
            background-size: 40px 40px; min-width: 2500px; min-height: 2500px;
        }

        .member { 
            position: absolute; width: 40px; height: 40px; 
            transition: all var(--anim-speed, 600ms) cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; align-items: center; justify-content: center; z-index: 10;
        }
        .circle { width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 11px; position: relative; }
        .circle::after { content: ''; position: absolute; top: -2px; width: 6px; height: 6px; background: #ffdb58; border-radius: 50%; border: 1px solid #000; }
        
        .army { background: var(--army-color); } .air { background: var(--air-color); } .navy { background: var(--navy-color); }
        .commander { background: var(--cmd-color); border: 2px solid #fff; }
        
        button { cursor: pointer; padding: 8px 12px; border-radius: 4px; border: none; font-weight: bold; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        
        .slider-container { background: #f1f3f5; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #dee2e6; }
        input[type=range] { width: 100%; cursor: pointer; }
    </style>
</head>
<body>

<div id="sidebar">
    <h3 style="margin:0;">CAF Engine v10</h3>
    <p style="font-size: 12px; color: #666; margin-bottom: 15px;">Tempo & Playback Control</p>

    <div class="slider-container">
        <label style="font-size: 12px; font-weight: bold; display: flex; justify-content: space-between;">
            Playback Speed <span id="speed-val">1.0x</span>
        </label>
        <input type="range" id="speed-slider" min="0.2" max="3" step="0.1" value="1" oninput="updateTempo(this.value)">
    </div>
    
    <div id="move-list"></div>

    <div style="border-top: 1px solid #ddd; padding-top: 15px; margin-top: auto;">
        <div class="btn-group">
            <button style="background:#2e7d32; color:white;" onclick="runSequence()">START</button>
            <button style="background:#c62828; color:white;" onclick="stopSequence()">HALT</button>
        </div>
        <div class="btn-group">
            <button style="background:#546e7a; color:white;" onclick="initSim()">RESET FORMATION</button>
            <button style="background:#78909c; color:white;" onclick="clearRoutine()">CLEAR ROUTINE</button>
        </div>
        <div id="status-display" style="font-size:11px; font-weight:bold;">State: Closed Order</div>
        <div id="warn-display" style="font-size:10px; color:#c62828; height:15px; margin-bottom:10px;"></div>
        <div class="btn-group">
            <button onclick="saveRoutine()" style="background:#333; color:white;">SAVE</button>
            <button onclick="document.getElementById('upload-input').click()" style="background:#333; color:white;">LOAD</button>
        </div>
        <input type="file" id="upload-input" style="display:none" onchange="loadRoutine(event)">
    </div>
</div>

<div id="main">
    <div class="controls">
        <select id="element"><option value="army">Army</option><option value="air">Air Force</option><option value="navy">Navy</option></select>
        <label>Count: <input type="number" id="count" value="11" style="width:45px"></label>
        <label><input type="checkbox" id="showCmdr" checked> Cmdr</label>
        <button onclick="initSim()" style="background:#333; color:white;">APPLY</button>
    </div>
    <div id="grid-floor"></div>
</div>

<script>
    const moves = ["None", "Quick March", "Right Turn", "Left Turn", "About Turn", "Right Wheel", "Left Wheel", "Open Order", "Close Order"];
    let squad = [], visualFacing = 0, structuralFront = 0, isRunning = false, isOpened = false;
    let animMs = 600; // Base speed

    function updateTempo(val) {
        document.getElementById('speed-val').innerText = val + 'x';
        animMs = 600 / val;
        document.documentElement.style.setProperty('--anim-speed', animMs + 'ms');
    }

    function createRow(i, val = "None", p = 1) {
        const div = document.createElement('div'); div.className = 'move-item';
        div.innerHTML = `<b>${i}</b>
            <select class="m-type" onchange="addNext(${i}); toggleP(this)">
                ${moves.map(m => `<option ${m === val ? 'selected' : ''}>${m}</option>`).join('')}
            </select>
            <input type="number" class="m-pace" value="${p}" min="1" style="width:40px; ${val.includes('Mar') ? '' : 'display:none'}">
            <button class="del-btn" onclick="this.parentElement.remove()">âœ•</button>`;
        return div;
    }

    function addNext(i) {
        const list = document.getElementById('move-list');
        if (i === list.children.length) list.appendChild(createRow(i + 1));
    }

    function toggleP(s) {
        s.nextElementSibling.style.display = s.value.includes('March') ? 'inline-block' : 'none';
    }

    function clearRoutine() {
        if(confirm("Clear all listed commands?")) {
            const list = document.getElementById('move-list');
            list.innerHTML = '';
            for (let i = 1; i <= 5; i++) list.appendChild(createRow(i));
            initSim();
        }
    }

    function initSim() {
        isRunning = false; isOpened = false;
        document.getElementById('status-display').innerText = "State: Closed Order";
        document.getElementById('warn-display').innerText = "";
        const count = parseInt(document.getElementById('count').value);
        const floor = document.getElementById('grid-floor');
        floor.innerHTML = ''; squad = []; visualFacing = 0; structuralFront = 0;
        const rows = count >= 10 ? 3 : (count >= 6 ? 2 : 1), cols = Math.ceil(count / rows);
        
        if (document.getElementById('showCmdr').checked) {
            squad.push(spawn(1000 + (cols * 20) - 20, 920, 'C', 'commander', -1));
        }
        
        let id = 1;
        for (let r = 0; r < rows; r++) {
            for (let c = cols - 1; c >= 0; c--) {
                const remainder = count % rows;
                let hide = (rows === 3 && ((remainder === 1 && r > 0 && c === 1) || (remainder === 2 && r === 1 && c === 1))) || (rows === 2 && count % 2 !== 0 && r === 1 && c === 1);
                if (!hide) squad.push(spawn(1000 + (c * 40), 1000 + (r * 40), id++, document.getElementById('element').value, r));
            }
        }
        updateVisuals();
    }

    function spawn(x, y, txt, cls, rIdx) {
        const div = document.createElement('div'); div.className = 'member';
        div.innerHTML = `<div class="circle ${cls}">${txt}</div>`;
        document.getElementById('grid-floor').appendChild(div);
        return { el: div, x, y, rIdx };
    }

    function getFlank(side) {
        const drillSquad = squad.filter(m => m.rIdx !== -1);
        const radFront = (visualFacing * Math.PI) / 180;
        const fvx = Math.sin(radFront), fvy = -Math.cos(radFront);
        const maxForward = Math.max(...drillSquad.map(m => m.x * fvx + m.y * fvy));
        const currentFrontRank = drillSquad.filter(m => Math.abs((m.x * fvx + m.y * fvy) - maxForward) < 10);
        const radFlank = ((visualFacing + 90) * Math.PI) / 180;
        const fx = Math.sin(radFlank), fy = -Math.cos(radFlank);
        return currentFrontRank.reduce((p, c) => {
            const pV = p.x * fx + p.y * fy, cV = c.x * fx + c.y * fy;
            return (side === 'right' ? cV > pV : cV < pV) ? c : p;
        });
    }

    async function runSequence() {
        if (isRunning) return; isRunning = true;
        const items = document.querySelectorAll('.move-item');
        for (let it of items) {
            if (!isRunning) break;
            const m = it.querySelector('.m-type').value, p = parseInt(it.querySelector('.m-pace').value);
            if (m === "None") continue;
            it.classList.add('active');
            for (let step = 0; step < (m.includes('Mar') ? p : 1); step++) {
                if (!isRunning) break;
                await execute(m);
                await new Promise(r => setTimeout(r, animMs));
            }
            it.classList.remove('active');
        }
        isRunning = false;
        updateVisuals();
    }

    function execute(type) {
        return new Promise(resolve => {
            document.getElementById('warn-display').innerText = "";
            let activePivot = null;
            if (type.includes("Turn")) {
                visualFacing += (type.includes("Right") ? 90 : (type.includes("About") ? 180 : -90));
            } else if (type === "Quick March") {
                const r = (visualFacing * Math.PI) / 180;
                const dx = Math.round(Math.sin(r)) * 40, dy = -Math.round(Math.cos(r)) * 40;
                squad.forEach(s => { s.x += dx; s.y += dy; });
            } else if (type.includes("Wheel")) {
                const isR = type.includes("Right"), angle = isR ? 90 : -90, rad = (angle * Math.PI) / 180;
                activePivot = getFlank(isR ? 'right' : 'left');
                visualFacing += angle; structuralFront += angle;
                squad.forEach(s => {
                    const tx = s.x - activePivot.x, ty = s.y - activePivot.y;
                    s.x = Math.round(activePivot.x + (tx * Math.cos(rad) - ty * Math.sin(rad)));
                    s.y = Math.round(activePivot.y + (tx * Math.sin(rad) + ty * Math.cos(rad)));
                });
            } else if (type.includes("Order")) {
                const angleDiff = Math.abs((visualFacing - structuralFront) % 180);
                if (angleDiff > 1 && angleDiff < 179) {
                    document.getElementById('warn-display').innerText = "Command Inhibited: Not in Line";
                    resolve(); return;
                }
                const isOpenCmd = type.includes("Open");
                if (isOpenCmd !== isOpened) {
                    isOpened = isOpenCmd;
                    document.getElementById('status-display').innerText = `State: ${isOpened ? 'Open' : 'Closed'} Order`;
                    const mult = isOpened ? 1 : -1;
                    const r = (structuralFront * Math.PI) / 180;
                    const dx = Math.round(Math.sin(r)) * 120 * mult, dy = -Math.round(Math.cos(r)) * 120 * mult;
                    squad.forEach(s => {
                        if (s.rIdx === 0 || s.rIdx === -1) { s.x += dx; s.y += dy; }
                        else if (s.rIdx === 2) { s.x -= dx; s.y -= dy; }
                    });
                }
            }
            updateVisuals(activePivot); resolve();
        });
    }

    function updateVisuals(piv = null) {
        const rm = getFlank('right');
        squad.forEach(m => {
            m.el.style.left = m.x + 'px'; m.el.style.top = m.y + 'px';
            m.el.style.transform = `rotate(${visualFacing}deg)`;
            m.el.classList.toggle('is-marker', m === rm && m.rIdx !== -1);
            m.el.classList.toggle('is-pivot', m === piv);
        });
    }

    function stopSequence() { isRunning = false; }
    function saveRoutine() {
        const data = { s: { c: document.getElementById('count').value, e: document.getElementById('element').value, m: document.getElementById('showCmdr').checked }, r: Array.from(document.querySelectorAll('.move-item')).map(it => ({ m: it.querySelector('.m-type').value, p: it.querySelector('.m-pace').value })).filter(x => x.m !== "None") };
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(data)], { type: 'application/json' })); a.download = 'drill.json'; a.click();
    }
    function loadRoutine(e) {
        const reader = new FileReader(); reader.onload = (ev) => {
            const data = JSON.parse(ev.target.result);
            document.getElementById('count').value = data.s.c; document.getElementById('element').value = data.s.e; document.getElementById('showCmdr').checked = data.s.m;
            initSim();
            const list = document.getElementById('move-list'); list.innerHTML = '';
            data.r.forEach((step, i) => { list.appendChild(createRow(i + 1, step.m, step.p)); addNext(i + 1); });
            if (list.children.length === 0) list.appendChild(createRow(1));
        }; reader.readAsText(e.target.files[0]);
    }
    for (let i = 1; i <= 5; i++) document.getElementById('move-list').appendChild(createRow(i));
    initSim();
</script>
</body>
</html>